(self.webpackChunkpreview_ui=self.webpackChunkpreview_ui||[]).push([[295],{2555:(T,P,a)=>{a.d(P,{t:()=>w});var s=a(2776),c=a(8042);class w extends s.x{constructor(f=1/0,m=1/0,h=c.l){super(),this._bufferSize=f,this._windowTime=m,this._timestampProvider=h,this._buffer=[],this._infiniteTimeWindow=!0,this._infiniteTimeWindow=m===1/0,this._bufferSize=Math.max(1,f),this._windowTime=Math.max(1,m)}next(f){const{isStopped:m,_buffer:h,_infiniteTimeWindow:g,_timestampProvider:y,_windowTime:v}=this;m||(h.push(f),!g&&h.push(y.now()+v)),this._trimBuffer(),super.next(f)}_subscribe(f){this._throwIfClosed(),this._trimBuffer();const m=this._innerSubscribe(f),{_infiniteTimeWindow:h,_buffer:g}=this,y=g.slice();for(let v=0;v<y.length&&!f.closed;v+=h?1:2)f.next(y[v]);return this._checkFinalizedStatuses(f),m}_trimBuffer(){const{_bufferSize:f,_timestampProvider:m,_buffer:h,_infiniteTimeWindow:g}=this,y=(g?1:2)*f;if(f<1/0&&y<h.length&&h.splice(0,h.length-y),!g){const v=m.now();let u=0;for(let C=1;C<h.length&&h[C]<=v;C+=2)u=C;u&&h.splice(0,u+1)}}}},2776:(T,P,a)=>{a.d(P,{u:()=>g,x:()=>h});var s=a(4630),c=a(4813);const b=(0,a(6889).d)(y=>function(){y(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});var f=a(9679),m=a(2046);let h=(()=>{class y extends s.y{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(u){const C=new g(this,this);return C.operator=u,C}_throwIfClosed(){if(this.closed)throw new b}next(u){(0,m.x)(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(const C of this.currentObservers)C.next(u)}})}error(u){(0,m.x)(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=u;const{observers:C}=this;for(;C.length;)C.shift().error(u)}})}complete(){(0,m.x)(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;const{observers:u}=this;for(;u.length;)u.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var u;return(null===(u=this.observers)||void 0===u?void 0:u.length)>0}_trySubscribe(u){return this._throwIfClosed(),super._trySubscribe(u)}_subscribe(u){return this._throwIfClosed(),this._checkFinalizedStatuses(u),this._innerSubscribe(u)}_innerSubscribe(u){const{hasError:C,isStopped:L,observers:O}=this;return C||L?c.Lc:(this.currentObservers=null,O.push(u),new c.w0(()=>{this.currentObservers=null,(0,f.P)(O,u)}))}_checkFinalizedStatuses(u){const{hasError:C,thrownError:L,isStopped:O}=this;C?u.error(L):O&&u.complete()}asObservable(){const u=new s.y;return u.source=this,u}}return y.create=(v,u)=>new g(v,u),y})();class g extends h{constructor(v,u){super(),this.destination=v,this.source=u}next(v){var u,C;null===(C=null===(u=this.destination)||void 0===u?void 0:u.next)||void 0===C||C.call(u,v)}error(v){var u,C;null===(C=null===(u=this.destination)||void 0===u?void 0:u.error)||void 0===C||C.call(u,v)}complete(){var v,u;null===(u=null===(v=this.destination)||void 0===v?void 0:v.complete)||void 0===u||u.call(v)}_subscribe(v){var u,C;return null!==(C=null===(u=this.source)||void 0===u?void 0:u.subscribe(v))&&void 0!==C?C:c.Lc}}},3406:(T,P,a)=>{a.d(P,{z:()=>w});var s=a(7914),c=a(9871);function w(b,f){const m="object"==typeof f;return new Promise((h,g)=>{const y=new c.Hp({next:v=>{h(v),y.unsubscribe()},error:g,complete:()=>{m?h(f.defaultValue):g(new s.K)}});b.subscribe(y)})}},872:(T,P,a)=>{a.d(P,{E:()=>c});const c=new(a(4630).y)(f=>f.complete())},5761:(T,P,a)=>{a.d(P,{of:()=>w});var s=a(4734),c=a(2582);function w(...b){const f=(0,s.yG)(b);return(0,c.D)(b,f)}},4487:(T,P,a)=>{a.d(P,{K:()=>b});var s=a(6111),c=a(4593),w=a(2871);function b(f){return(0,w.e)((m,h)=>{let v,g=null,y=!1;g=m.subscribe((0,c.x)(h,void 0,void 0,u=>{v=(0,s.Xf)(f(u,b(f)(m))),g?(g.unsubscribe(),g=null,v.subscribe(h)):y=!0})),y&&(g.unsubscribe(),g=null,v.subscribe(h))})}},4154:(T,P,a)=>{a.d(P,{h:()=>b});var s=a(872),c=a(2871),w=a(4593);function b(f){return f<=0?()=>s.E:(0,c.e)((m,h)=>{let g=[];m.subscribe((0,w.x)(h,y=>{g.push(y),f<g.length&&g.shift()},()=>{for(const y of g)h.next(y);h.complete()},void 0,()=>{g=null}))})}},8042:(T,P,a)=>{a.d(P,{l:()=>s});const s={now:()=>(s.delegate||Date).now(),delegate:void 0}},7914:(T,P,a)=>{a.d(P,{K:()=>c});const c=(0,a(6889).d)(w=>function(){w(this),this.name="EmptyError",this.message="no elements in sequence"})},4734:(T,P,a)=>{a.d(P,{_6:()=>m,jO:()=>b,yG:()=>f});var s=a(4648),c=a(5942);function w(h){return h[h.length-1]}function b(h){return(0,s.m)(w(h))?h.pop():void 0}function f(h){return(0,c.K)(w(h))?h.pop():void 0}function m(h,g){return"number"==typeof w(h)?h.pop():g}},5295:(T,P,a)=>{a.r(P),a.d(P,{AbstractDynamicComponent:()=>g,AbstractDynamicLoaderComponent:()=>k,AbstractPluginHandler:()=>ue,AbstractReferenceComponent:()=>ye,BaseDynamicEvent:()=>ee,BaseDynamicEventSource:()=>q,BeautifierPipe:()=>J,CHANNEL_CHANGE_NAME:()=>Ee,COMMAND_PROVIDER:()=>w,CommonConfigService:()=>be,CommonTestManager:()=>Pe,ComponentLoaderService:()=>U,DONT_CODE_COMMON_CONFIG:()=>f,DONT_CODE_CORE:()=>b,DynamicEventType:()=>x,DynamicInsertPoint:()=>K,EntityListManager:()=>te,EntityStoreService:()=>Ce,PluginBaseComponent:()=>$,PluginCommonModule:()=>ne,PluginCommonTestModule:()=>A,PluginHandlerHelper:()=>H,PossibleTemplateList:()=>Y,SANDBOX_MENUS:()=>we,SubFieldInfo:()=>j,TemplateList:()=>Z,ValueService:()=>_e});var s=a(1855),c=a(9130);let w=new s.InjectionToken("Inject the current command provider interface");const b=new s.InjectionToken("Dont-code core object"),f=new s.InjectionToken("DontCodeCommonLibConfig");var m=a(7527),h=a(4813);let g=(()=>{class r{constructor(){this.parentPosition=null,this.subscriptions=new h.w0}setName(e){this.name=e}getValue(){return null!=this.form&&this.updateValueFromForm(),this.value}setValue(e){this.value=e,null!=this.form&&this.hydrateValueToForm()}setParentPosition(e){this.parentPosition=e}setForm(e){this.form=e,null!=this.form&&null!=this.name&&this.createAndRegisterFormControls()}getForm(){return this.form}createAndRegisterFormControls(){const e=new m.FormControl(null,{updateOn:"blur"});this.form.registerControl(this.name,e)}transformToFormGroupValue(e){return e}transformFromFormGroupValue(e){return e}hydrateValueToForm(){if(null!=this.name){const e=this.form.get(this.name);if(null==e)throw new Error("No form control for the name "+this.name);{const t=this.transformToFormGroupValue(this.value);e.setValue(t,{emitEvent:!1})}}}updateValueFromForm(){if(null==this.name)return!1;const e=this.form.get(this.name);if(null==e)throw new Error("No form control for the name "+this.name);return!!e.dirty&&(this.value=this.transformFromFormGroupValue(e.value),e.markAsPristine({onlySelf:!0}),!0)}static toBeautifyString(e,t){if(null==e)return null;let i="";switch(Array.isArray(e)&&(e=e[0]),typeof e){case"string":i=e;break;case"object":i=e instanceof Date?e.toLocaleDateString():JSON.stringify(e,null,2);break;case"undefined":break;default:i=e.toLocaleString()}return null!=t&&i.length>t&&(i=i.substring(0,t-3)+"..."),i}listEventSources(){return[]}selectEventSourceFor(e,t){const i=this.listEventSources();for(const o of i)if(o.type===e){if(null==t)return o;if(o.name==t)return o}return null}ngOnDestroy(){this.subscriptions.unsubscribe()}}return r.\u0275fac=function(e){return new(e||r)},r.\u0275cmp=s.\u0275\u0275defineComponent({type:r,selectors:[["ng-component"]],decls:0,vars:0,template:function(e,t){},encapsulation:2}),r})();var y=a(2555);new Error("timeout while waiting for mutex to become available"),new Error("mutex already locked");const C=new Error("request for lock canceled");class O{constructor(n,e=C){this._value=n,this._cancelError=e,this._weightedQueues=[],this._weightedWaiters=[]}acquire(n=1){if(n<=0)throw new Error(`invalid weight ${n}: must be positive`);return new Promise((e,t)=>{this._weightedQueues[n-1]||(this._weightedQueues[n-1]=[]),this._weightedQueues[n-1].push({resolve:e,reject:t}),this._dispatch()})}runExclusive(n,e=1){return function(r,n,e,t){return new(e||(e=Promise))(function(o,l){function p(E){try{_(t.next(E))}catch(M){l(M)}}function d(E){try{_(t.throw(E))}catch(M){l(M)}}function _(E){E.done?o(E.value):function i(o){return o instanceof e?o:new e(function(l){l(o)})}(E.value).then(p,d)}_((t=t.apply(r,n||[])).next())})}(this,void 0,void 0,function*(){const[t,i]=yield this.acquire(e);try{return yield n(t)}finally{i()}})}waitForUnlock(n=1){if(n<=0)throw new Error(`invalid weight ${n}: must be positive`);return new Promise(e=>{this._weightedWaiters[n-1]||(this._weightedWaiters[n-1]=[]),this._weightedWaiters[n-1].push(e),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(n){this._value=n,this._dispatch()}release(n=1){if(n<=0)throw new Error(`invalid weight ${n}: must be positive`);this._value+=n,this._dispatch()}cancel(){this._weightedQueues.forEach(n=>n.forEach(e=>e.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var n;for(let e=this._value;e>0;e--){const t=null===(n=this._weightedQueues[e-1])||void 0===n?void 0:n.shift();if(!t)continue;const i=this._value,o=e;this._value-=e,e=this._value+1,t.resolve([i,this._newReleaser(o)])}this._drainUnlockWaiters()}_newReleaser(n){let e=!1;return()=>{e||(e=!0,this.release(n))}}_drainUnlockWaiters(){for(let n=this._value;n>0;n--)this._weightedWaiters[n-1]&&(this._weightedWaiters[n-1].forEach(e=>e()),this._weightedWaiters[n-1]=[])}}class W{constructor(n){this._semaphore=new O(1,n)}acquire(){return r=this,n=void 0,t=function*(){const[,n]=yield this._semaphore.acquire();return n},new((e=void 0)||(e=Promise))(function(o,l){function p(E){try{_(t.next(E))}catch(M){l(M)}}function d(E){try{_(t.throw(E))}catch(M){l(M)}}function _(E){E.done?o(E.value):function i(o){return o instanceof e?o:new e(function(l){l(o)})}(E.value).then(p,d)}_((t=t.apply(r,n||[])).next())});var r,n,e,t}runExclusive(n){return this._semaphore.runExclusive(()=>n())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}let U=(()=>{class r{constructor(e,t,i,o){this.injector=e,this.dontCodeCore=t,this.previewMgr=i,this.provider=o,this.moduleMap=new Map,this.mutex=new W}getOrCreatePluginModuleRef(e){return this.mutex.acquire().then(t=>{try{let i=this.moduleMap.get(e);return i||(i=(0,s.createNgModule)((0,s.getNgModuleById)("dontcode-plugin/"+e),this.injector),i&&this.moduleMap.set(e,i)),i}finally{t()}})}loadPluginModule(e){return this.getOrCreatePluginModuleRef(e.class.source).then(t=>(null!=t&&this.dontCodeCore.initPlugins(),t))}insertComponentForFieldType(e,t){return this.insertComponent("creation/entities/fields/type",t,e)}insertComponent(e,t,i){let l,o=e.positionInSchema;o?(l=!0,i||(i=this.provider?.getJsonAt(e.position))):(l=!1,o=e);const p=this.previewMgr.retrieveHandlerConfig(o,i);return p?this.loadPluginModule(p).then(d=>{const _=d.instance.exposedPreviewHandlers().get(p.class.name);return this.createComponent(_,t,d,l?e:null)}).catch(d=>(console.error("Cannot load module because of ",d),Promise.reject("Cannot load module for source "+p.class.source+" because of "+d))):Promise.resolve(null)}createComponent(e,t,i,o){const d=t.createComponent(e,{injector:this.injector,ngModuleRef:i}).instance;if(d.initCommandFlow){if(!o)throw new Error("Component "+d.constructor.name+" is a PreviewHandler and parent position is missing.");if(!this.provider)throw new Error("Component "+d.constructor.name+" is a PreviewHandler and CommandProviderInterface is missing.");d.initCommandFlow(this.provider,o)}return d}registerModuleForTest(e,t){this.moduleMap.set(t,null==e.instance?(0,s.createNgModule)(e,this.injector):e)}}return r.\u0275fac=function(e){return new(e||r)(s.\u0275\u0275inject(s.Injector),s.\u0275\u0275inject(b),s.\u0275\u0275inject(c.DontCodePreviewManager),s.\u0275\u0275inject(w,8))},r.\u0275prov=s.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"}),r})(),K=(()=>{class r{}return r.\u0275fac=function(e){return new(e||r)},r.\u0275dir=s.\u0275\u0275defineDirective({type:r,selectors:[["dtcde-dynamic"]]}),r})(),k=(()=>{class r extends g{constructor(e,t,i){super(),this.loader=e,this.injector=t,this.ref=i,this.fields=new Array,this.fieldsMap=new Map,this.parentForm=null,this.componentInited=new y.t}defineSubField(e,t){const i=new j(e,t);this.addSubField(i)}getSubField(e){const t=this.fieldsMap.get(e);if(null!=t)return this.fields[t]}addSubField(e){const t=this.fields.push(e);return this.fieldsMap.set(e.name,t-1),t}getSubFields(){return this.fields}setForm(e){if(this.name){const t=new m.FormGroup({},{updateOn:"blur"});e.registerControl(this.name,t),super.setForm(t),this.parentForm=e}else super.setForm(e),this.parentForm=null;this.preloadSubFields()}hydrateValueToForm(){if(null==this.parentForm)super.hydrateValueToForm();else{let e=this.transformToFormGroupValue(this.value);for(const t in this.form.controls)null==this.fieldsMap.get(t)&&this.form.get(t)?.setValue(e&&e[t],{emitEvent:!1})}}updateValueFromForm(){if(null==this.parentForm)return super.updateValueFromForm();{let e=!1;for(const t in this.form.controls)if(null==this.fieldsMap.get(t)){const i=this.form.get(t);if(null!=i&&i.dirty){const o=this.transformFromFormGroupValue(i?.value);null==this.value&&(this.value={}),this.value[t]=o,e=!0,i.markAsPristine({onlySelf:!0})}}return e}}setValue(e){super.setValue(e);for(const t of this.fields)this.setSubFieldValue(t,null!=e?e[t.name]:void 0)}getValue(){let e=super.getValue();for(const t of this.fields){const i=this.getSubFieldValue(t);null!=i&&null==e&&(this.value={},e=this.value),e[t.name]!==i&&(e[t.name]=i)}return e}subFieldFullEditTemplate(e){const t="string"==typeof e?this.getSubField(e):e,i=t?.component;let o=null;if(null!=i&&(o=i.providesTemplates(t?.type).forFullEdit),null==e)throw new Error("No template for subField "+t?.name+" of component "+this.name);return o}subFieldInlineViewTemplate(e){const t="string"==typeof e?this.getSubField(e):e,i=t?.component;let o=null;if(null!=i&&(o=i.providesTemplates(t?.type).forInlineView),null==e)throw new Error("No template for subField "+t?.name+" of component "+this.name);return o}subFieldFullViewTemplate(e){const t="string"==typeof e?this.getSubField(e):e,i=t?.component;let o=null;if(null!=i&&(o=i.providesTemplates(t?.type).forFullView),null==e)throw new Error("No template for subField "+t?.name+" of component "+this.name);return o}loadSubField(e,t,i){const o="string"==typeof e?this.getSubField(e):e,l=o?.component;return null==l?this.loader.insertComponentForFieldType(t,this.dynamicInsertPoint).then(p=>null!=p?(this.prepareComponent(p,t,null!=o?o.name:null,i),p):null):Promise.resolve(l)}getSubFieldValue(e){const t="string"==typeof e?this.getSubField(e):e,i=t?.component;if(null!=i)return i.getValue();if(null!=this.form&&null!=t)return this.form.get(t.name)?.value;throw new Error("Cannot provide value for non existent subField "+e)}setSubFieldValue(e,t){const i="string"==typeof e?this.getSubField(e):e,o=i?.component;if(null!=o)o.setValue(t);else if(null!=this.form&&null!=i){const l={};let p=r.toBeautifyString(t);null==p&&(p=null),l[i.name]=p,this.form.patchValue(l,{emitEvent:!1})}}loadSubComponent(e,t,i,o){return new Promise((l,p)=>this.componentInited.subscribe({complete:()=>{l()},error:d=>{p(d)}})).then(()=>null==this.dynamicInsertPoint?null:this.loader.insertComponent(e,this.dynamicInsertPoint,o).then(l=>null!=l?this.prepareComponent(l,t,i,o):null))}prepareComponent(e,t,i,o){return i&&(null!=this.form&&(e.setName(i),e.setForm(this.form)),e.setValue(o)),e}applyComponentToSubField(e,t,i){let o=this.getSubField(i);return null==o?(o=new j(i,t,e),this.addSubField(o),!0):(o.component=e,!1)}ngAfterViewInit(){this.componentInited.complete(),this.preloadSubFields()}preloadSubFields(){if(null!=this.dynamicInsertPoint){let e=!1;for(const t of this.fields)null==t.component&&this.loadSubField(t.name,t.type,this.value?this.value[t.name]:void 0).then(o=>{null!=o&&this.applyComponentToSubField(o,t.type,t.name),null!=this.value&&!e&&(this.ref.detectChanges(),e=!0)})}}}return r.\u0275fac=function(e){return new(e||r)(s.\u0275\u0275directiveInject(U),s.\u0275\u0275directiveInject(s.Injector),s.\u0275\u0275directiveInject(s.ChangeDetectorRef))},r.\u0275cmp=s.\u0275\u0275defineComponent({type:r,selectors:[["ng-component"]],viewQuery:function(e,t){if(1&e&&s.\u0275\u0275viewQuery(K,5,s.ViewContainerRef),2&e){let i;s.\u0275\u0275queryRefresh(i=s.\u0275\u0275loadQuery())&&(t.dynamicInsertPoint=i.first)}},features:[s.\u0275\u0275InheritDefinitionFeature],decls:0,vars:0,template:function(e,t){},encapsulation:2}),r})();class j{constructor(n,e,t){this.name=n,this.type=e,this.component=t}}var Q=a(5582),V=a(5846),oe=a(4154),se=a(4487),le=a(5761),z=a(2582),N=a(3406);class H{constructor(){this.subscriptions=new h.w0,this.entityPointer=null,this.provider=null,this.changeHandler=null,this.actionPerformer=null,this.mutex=new W}initCommandFlow(n,e,t,i){this.entityPointer=e,this.provider=n,this.changeHandler=t,null!=i?this.actionPerformer=i:null!=t.performAction&&(this.actionPerformer=t)}decomposeJsonToMultipleChanges(n,e){if("object"==typeof e&&this.provider){let t;const i=this.provider.getSchemaManager();for(const o in e)if(e.hasOwnProperty(o)){const l=i.generateSubSchemaPointer(n,o),p=i.locateItem(l.positionInSchema);p?.isArray()&&l.isProperty?this.decomposeJsonToMultipleChanges(l,e[o]):(t=new c.Change(c.ChangeType.RESET,n.position+"/"+o,e[o],l),!p&&t.pointer&&(t.pointer.isProperty=!1),null!=this.changeHandler&&this.changeHandler.handleChange(t))}}}initChangeListening(n){this.initOtherChangeListening(n,this.entityPointer)}initOtherChangeListening(n,e){if(!this.provider||!e)throw new Error("Cannot listen to change before initCommandFlow is called");{let t=e.position;!0!==n&&(t+="/?"),this.subscriptions.add(this.provider.receiveCommands(t).pipe((0,V.U)(i=>{null!=i.actionType?this.actionPerformer&&i.running?.next(this.actionPerformer.performAction(i)):this.changeHandler&&this.changeHandler.handleChange(i)})).subscribe())}}applyUpdatesToArray(n,e,t,i,o,l){return this.applyUpdatesToArrayAsync(n,e,t,i,(p,d)=>Promise.resolve(o(p,d)))}applyUpdatesToArrayAsync(n,e,t,i,o,l,p){return this.mutex.runExclusive(()=>{try{if(!this.provider)throw new Error("Cannot apply updates before initCommandFlow is called");t.pointer||(t.pointer=this.provider.calculatePointerFor(t.position)),l=l??this.entityPointer?.position,null!=i&&(l=l+"/"+i);const d=t.pointer.containerPosition===l;let _=d?t.pointer.lastElement:c.DontCodeModelPointer.lastElementOf(t.pointer.containerPosition)??null,E=t.pointer.isProperty?t.pointer.lastElement:null,M=null,R=null,D=-1,F=-1;switch(null!=_&&e.has(_)&&(D=e.get(_),R=n[D],M=(0,le.of)(R)),t.beforeKey&&(F=e.get(t.beforeKey)),t.type){case c.ChangeType.ADD:case c.ChangeType.UPDATE:case c.ChangeType.RESET:if(null!=E){if(!R||R&&(!p||!p(R,E,t.value))){const S=this.provider.getJsonAt(t.pointer.containerPosition),I=this.provider.calculatePointerFor(t.pointer.containerPosition);if(I.isProperty)throw new Error("A parent of a property "+t.pointer.position+" must be an array");M=(0,z.D)(o(I,S))}}else M=(0,z.D)(o(t.pointer,t.value));break;case c.ChangeType.MOVE:-1!==D&&d&&_&&(-1!==F&&F>D&&F--,n.splice(D,1),e.forEach((S,I)=>{S>D&&e.set(I,S-1)}),e.delete(_),D=-1);break;case c.ChangeType.DELETE:-1!==D&&d&&_&&(n.splice(D,1),e.forEach((S,I)=>{S>D&&e.set(I,S-1)}),e.delete(_)),M=null}return M?(0,N.z)(M.pipe((0,V.U)(S=>{if(-1!==D)n[D]=S;else if(-1!==F){if(n.splice(F,0,S),e.forEach((I,Se)=>{I>=F&&e.set(Se,I+1)}),null==_)throw new Error("Cannot set targetPos "+F+" without knowing the itemId");e.set(_,F)}else{if(n.push(S),null==_)throw new Error("Cannot set targetPos "+F+" without knowing the itemId");e.set(_,e.size)}return n}),(0,oe.h)(1),(0,se.K)(S=>Promise.reject(S)))):Promise.resolve(n)}catch(d){return Promise.reject(d)}})}unsubscribe(){this.subscriptions.unsubscribe()}performAction(n){var e=this;return(0,Q.Z)(function*(){if(null==e.provider)return Promise.reject("No provider for the component at position "+e.entityPointer?.position);yield e.provider.sendCommand(n)})()}}let $=(()=>{class r extends k{constructor(e,t,i){super(e,t,i),this.pluginHelper=new H,this.entityPointer=null,this.provider=null}ngOnDestroy(){this.pluginHelper.unsubscribe(),super.ngOnDestroy()}updateValueOnFormChanges(){this.subscriptions.add(this.form.valueChanges.pipe((0,V.U)(e=>(this.getValue(),e))).subscribe())}initCommandFlow(e,t){this.entityPointer=t,this.provider=e,this.pluginHelper.initCommandFlow(e,t,this)}initChangeListening(e){this.pluginHelper.initChangeListening(e)}decomposeJsonToMultipleChanges(e,t){this.pluginHelper.decomposeJsonToMultipleChanges(e,t)}decodeStringField(e,t){if(e.pointer?.lastElement===t)return e.value}applyUpdatesToArray(e,t,i,o,l,p,d){return this.applyUpdatesToArrayAsync(e,t,i,o,(_,E)=>Promise.resolve(l(_,E)),p)}applyUpdatesToArrayAsync(e,t,i,o,l,p,d){return this.pluginHelper.applyUpdatesToArrayAsync(e,t,i,o,l,p,d)}updateSubFieldsWithChange(e,t,i){return this.applyUpdatesToArrayAsync(this.fields,this.fieldsMap,e,t,(o,l)=>this.loadSubComponent(o,l.type,l.name).then(p=>new j(l.name,l.type,p??void 0)),i,(o,l,p)=>l===c.DontCodeModel.APP_FIELDS_NAME_NODE&&(o.name=p,!0)).then(o=>(this.fields=o,this.rebuildForm(),o))}rebuildForm(){if(null==this.form)return;const e=new Set;for(const t in this.form.controls)e.add(t);for(const t of this.fields){let i=null;this.value&&this.value[t.name]&&(i=this.value[t.name]),e.delete(t.name),null!=t.component?t.component?.setValue(i):(i=r.toBeautifyString(i),this.form.registerControl(t.name,new m.FormControl(i,m.Validators.required)))}e.forEach(t=>{this.form.removeControl(t)})}}return r.\u0275fac=function(e){return new(e||r)(s.\u0275\u0275directiveInject(U),s.\u0275\u0275directiveInject(s.Injector),s.\u0275\u0275directiveInject(s.ChangeDetectorRef))},r.\u0275cmp=s.\u0275\u0275defineComponent({type:r,selectors:[["ng-component"]],features:[s.\u0275\u0275InheritDefinitionFeature],decls:0,vars:0,template:function(e,t){},encapsulation:2}),r})(),J=(()=>{class r{transform(e,...t){return $.toBeautifyString(e,t[0])}}return r.\u0275fac=function(e){return new(e||r)},r.\u0275pipe=s.\u0275\u0275definePipe({name:"beautifier",type:r,pure:!0}),r})();var X=a(8905),B=a(1395);class ue{constructor(){this.subscriptions=new h.w0,this.pluginHelper=new H,this.entityPointer=null,this.provider=null}unsubscribe(){this.pluginHelper.unsubscribe(),this.subscriptions.unsubscribe()}initCommandFlow(n,e){this.entityPointer=e,this.provider=n,this.pluginHelper.initCommandFlow(n,e,this)}initChangeListening(){this.pluginHelper.initChangeListening()}decomposeJsonToMultipleChanges(n,e){this.pluginHelper.decomposeJsonToMultipleChanges(n,e)}applyUpdatesToArray(n,e,t,i,o,l){return this.applyUpdatesToArrayAsync(n,e,t,i,(p,d)=>Promise.resolve(o(p,d)))}applyUpdatesToArrayAsync(n,e,t,i,o,l,p){return this.pluginHelper.applyUpdatesToArrayAsync(n,e,t,i,o,l,p)}performAction(n){return Promise.resolve(void 0)}}class Z{constructor(n,e,t){this.forInlineView=n,this.forFullView=e,this.forFullEdit=t}}class Y{constructor(n,e,t){this.forInlineView=n,this.forFullView=e,this.forFullEdit=t}}class q{constructor(n,e,t){this.name=n,this.type=e,this.eventSource=t}}var x=(()=>{return(r=x||(x={})).VALUE_CHANGE="VALUE_CHANGE",r.SELECTION_CHANGE="SELECTION_CHANGE",x;var r})();class ee{constructor(n,e,t){this.name=n,this.type=e,this.value=t}}var ae=a(1295);const ce=["inlineView"],de=["fullEditView"];function he(r,n){if(1&r&&s.\u0275\u0275text(0),2&r){const e=s.\u0275\u0275nextContext();s.\u0275\u0275textInterpolate(e.value)}}function pe(r,n){if(1&r&&(s.\u0275\u0275elementStart(0,"div"),s.\u0275\u0275text(1),s.\u0275\u0275elementEnd()),2&r){const e=s.\u0275\u0275nextContext(4);s.\u0275\u0275advance(1),s.\u0275\u0275textInterpolate1(" ",e.value," ")}}function fe(r,n){if(1&r&&s.\u0275\u0275template(0,pe,2,1,"div",7),2&r){const e=s.\u0275\u0275nextContext(3);s.\u0275\u0275property("ngIf",e.value)}}function me(r,n){1&r&&s.\u0275\u0275text(0),2&r&&s.\u0275\u0275textInterpolate1(" ",n.$implicit," ")}function ve(r,n){if(1&r){const e=s.\u0275\u0275getCurrentView();s.\u0275\u0275elementContainerStart(0,3),s.\u0275\u0275elementStart(1,"p-dropdown",4),s.\u0275\u0275listener("onChange",function(i){s.\u0275\u0275restoreView(e);const o=s.\u0275\u0275nextContext(2);return s.\u0275\u0275resetView(o.valueChanged(i))}),s.\u0275\u0275template(2,fe,1,1,"ng-template",5),s.\u0275\u0275template(3,me,1,1,"ng-template",6),s.\u0275\u0275elementEnd(),s.\u0275\u0275elementContainerEnd()}if(2&r){const e=s.\u0275\u0275nextContext(2);s.\u0275\u0275property("formGroup",e.form),s.\u0275\u0275advance(1),s.\u0275\u0275property("options",e.options)("formControlName",e.name)("filter",!0)("showClear",!0)("lazy",!0)}}function ge(r,n){if(1&r&&s.\u0275\u0275template(0,ve,4,6,"ng-container",2),2&r){const e=s.\u0275\u0275nextContext();s.\u0275\u0275property("ngIf",e.form)}}let ye=(()=>{class r extends g{constructor(e,t){super(),this.modelMgr=e,this.storeMgr=t,this.valueChange=new s.EventEmitter,this.targetEntitiesPos=null,this.targetEntitiesProperty=null,this.options=new Array,null==e&&(this.modelMgr=c.dtcde.getModelManager()),null==t&&(this.storeMgr=c.dtcde.getStoreManager())}canProvide(e){return new Y(!0,!1,!0)}providesTemplates(e){return new Z(this.inlineView,null,this.fullEditView)}setTargetEntitiesWithName(e,t){const i=this.modelMgr.queryModelToSingle("$.creation.entities[?(@.name=='"+e+"')]");if(null==i)throw console.error("Cannot find an entity with name "+e+" in the model."),new Error("Cannot find an entity with name "+e+" in the model.");return this.targetEntitiesPos=i.pointer,null==this.targetEntitiesPos?Promise.resolve(!1):(this.targetEntitiesProperty=t??null,(0,N.z)(this.possibleValues()).then(o=>(this.options=o,!0)))}possibleValues(){if(null==this.targetEntitiesPos)throw new Error("Missing query of target entity for class "+this.constructor.name);const e=this.storeMgr.searchEntities(this.targetEntitiesPos);if(null!=this.targetEntitiesProperty){const t=this.targetEntitiesProperty;return e.pipe((0,V.U)(i=>i.map(o=>o[t])))}return e}listEventSources(){const e=super.listEventSources();return e.push(new q("Value",x.VALUE_CHANGE,this.valueChange.asObservable())),e}valueChanged(e){this.valueChange.emit(new ee("Value",x.VALUE_CHANGE,e.value))}setValue(e){null!=e&&null!=this.options&&-1==this.options.findIndex(t=>t==e)&&null!=this.options[1]&&(e=this.options[1].toString()),super.setValue(e)}}return r.\u0275fac=function(e){return new(e||r)(s.\u0275\u0275directiveInject(c.DontCodeModelManager,8),s.\u0275\u0275directiveInject(c.DontCodeStoreManager,8))},r.\u0275cmp=s.\u0275\u0275defineComponent({type:r,selectors:[["dontcode-reference"]],viewQuery:function(e,t){if(1&e&&(s.\u0275\u0275viewQuery(ce,7),s.\u0275\u0275viewQuery(de,7)),2&e){let i;s.\u0275\u0275queryRefresh(i=s.\u0275\u0275loadQuery())&&(t.inlineView=i.first),s.\u0275\u0275queryRefresh(i=s.\u0275\u0275loadQuery())&&(t.fullEditView=i.first)}},outputs:{valueChange:"valueChange"},features:[s.\u0275\u0275InheritDefinitionFeature],decls:4,vars:0,consts:[["inlineView",""],["fullEditView",""],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["placeholder","Select a reference",3,"options","formControlName","filter","showClear","lazy","onChange"],["pTemplate","selectedItem"],["pTemplate","item"],[4,"ngIf"]],template:function(e,t){1&e&&(s.\u0275\u0275template(0,he,1,1,"ng-template",null,0,s.\u0275\u0275templateRefExtractor),s.\u0275\u0275template(2,ge,1,1,"ng-template",null,1,s.\u0275\u0275templateRefExtractor))},dependencies:[B.NgIf,X.Dropdown,ae.PrimeTemplate,m.NgControlStatus,m.NgControlStatusGroup,m.FormGroupDirective,m.FormControlName],changeDetection:0}),r})(),Ce=(()=>{class r{constructor(e,t){this.storeMgr=e,this.modelMgr=t,this.listsByPosition=new Map}retrieveListManager(e,t){let i=this.listsByPosition.get(e.position);return null==i&&(i=new te(e,t,this.storeMgr,this.modelMgr),this.listsByPosition.set(e.position,i)),i}}return r.\u0275fac=function(e){return new(e||r)(s.\u0275\u0275inject(c.DontCodeStoreManager),s.\u0275\u0275inject(c.DontCodeModelManager))},r.\u0275prov=s.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();class te{constructor(n,e,t,i){this.storeMgr=t,this.modelMgr=i,this.entities=null,this.prepared=null,this.pointer=n,this.description=e}push(n){this.entities=null==this.entities?new Array(n):[...this.entities,n]}updateWithDetailedEntity(n){const e=n._id,t=new Array;return null!=this.entities?(this.entities.forEach(i=>{i._id==e?(n={...n,...i},t.push(n)):t.push(i)}),this.entities=[...t]):this.entities=[n],n}replace(n){if(null==this.entities)return!1;const e=n._id;let t=!1;const i=new Array;return this.entities.forEach(o=>{o._id==e?(i.push(n),t=!0):i.push(o)}),this.entities=[...i],t}remove(n){if(null==this.entities)return Promise.resolve(!1);const e=n._id;return null==e?new Promise(t=>{null!=this.entities?(this.entities=this.entities.filter(i=>i!==n),this.prepared=null,t(!0)):t(!1)}):this.storeMgr.deleteEntity(this.pointer.position,e).then(t=>(t&&null!=this.entities&&(this.entities=this.entities.filter(i=>i!==n),this.prepared=null),t)).catch(t=>(console.error(t.message),!1))}reset(){null!=this.entities&&(this.entities.length=0),this.prepared=null}store(n){return this.prepared=null,this.storeMgr.storeEntity(this.pointer.position,n)}storeAllChanged(){var n=this;return(0,Q.Z)(function*(){if(null!=n.entities){n.prepared=null;for(const e of n.entities)yield n.storeMgr.storeEntity(n.pointer.position,e)}})()}loadAll(){return(0,N.z)(this.storeMgr.searchEntities(this.pointer.position).pipe((0,V.U)(n=>{this.prepared=null,this.entities=[...n]})),{defaultValue:void 0})}searchAndPrepareEntities(n,e,t,...i){let o=null!=n?Object.values(n):[];const l=o.length>0?o[0]:void 0;o=null!=e?Object.values(e):[];const p=o.length>0?new c.DontCodeStoreGroupby(o[0].of,o[0].display,o[0].show):void 0;if(null!=this.entities){this.prepared=null;let _,d=this.entities;return null!=i&&(d=c.StoreProviderHelper.applyFilters(d,...i)),null!=t&&(d=t.postLoadingTransformation(d)),null!=l&&(d=c.StoreProviderHelper.multiSortArray(d,l)),null!=p&&(_=c.StoreProviderHelper.calculateGroupedByValues(d,p,this.modelMgr,this.pointer)),(null!=i||null!=n||null!=e)&&(this.prepared=new c.DontCodeStorePreparedEntities(d,l,_)),this.entities=d,Promise.resolve()}return(0,N.z)(this.storeMgr.searchAndPrepareEntities(this.pointer.position,l,p,t,...i).pipe((0,V.U)(d=>{this.prepared=d,this.entities=this.prepared.sortedData})))}loadDetailFromKey(n){return null==n?Promise.reject("Cannot load entity with null key"):this.storeMgr.loadEntity(this.pointer.position,n).then(e=>null!=e?this.updateWithDetailedEntity(e):e)}loadDetailOf(n){return this.loadDetailFromKey(n._id)}}let _e=(()=>{class r{constructor(e){this.modelMgr=e}getContent(){return this.modelMgr.getContent()}resetContent(e){this.modelMgr.resetContent(e)}findAtPosition(e,t){return this.modelMgr.findAtPosition(e,t)}queryModelToArray(e,t){return this.modelMgr.queryModelToArray(e,t)}queryModelToSingle(e,t){return this.modelMgr.queryModelToSingle(e,t)}findAllPossibleTargetsOfProperty(e,t,i){return this.modelMgr.findAllPossibleTargetsOfProperty(e,t,i)}findTargetOfProperty(e,t,i){return this.modelMgr.findTargetOfProperty(e,t,i)}}return r.\u0275fac=function(e){return new(e||r)(s.\u0275\u0275inject(c.DontCodeModelManager))},r.\u0275prov=s.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();const Ee="preview-ui-changes",we=new s.InjectionToken("Allows addition of menus");let be=(()=>{class r{constructor(e){this.updates=new y.t(1),this.config=e,null==this.config&&(this.config={})}getConfig(){return this.config}getUpdates(){return this.updates}updateConfig(e,t){this.config[e]=t,this.updates.next(this.config)}batchUpdateConfig(e){this.config=Object.assign(this.config,e),this.updates.next(this.config)}}return r.\u0275fac=function(e){return new(e||r)(s.\u0275\u0275inject(f,8))},r.\u0275prov=s.\u0275\u0275defineInjectable({token:r,factory:r.\u0275fac,providedIn:"root"}),r})(),ne=(()=>{class r{static forRoot(){return{ngModule:r,providers:[{provide:b,useValue:c.dtcde},{provide:c.DontCodeSchemaManager,useValue:c.dtcde.getSchemaManager()},{provide:c.DontCodeModelManager,useValue:c.dtcde.getModelManager()},{provide:c.DontCodePreviewManager,useValue:c.dtcde.getPreviewManager()},{provide:c.DontCodeStoreManager,useValue:c.dtcde.getStoreManager()},{provide:c.DontCodeChangeManager,useValue:c.dtcde.getChangeManager()},J]}}}return r.\u0275fac=function(e){return new(e||r)},r.\u0275mod=s.\u0275\u0275defineNgModule({type:r}),r.\u0275inj=s.\u0275\u0275defineInjector({imports:[B.CommonModule,X.DropdownModule,m.ReactiveFormsModule]}),r})();class Pe{static registerComponentForType(n,e,t){c.dtcde.registerPlugin(new Me({forType:n,name:e})),A.previewHandlers.set(e,t)}}class Me{constructor(n){this.testComponents=null,this.CONFIG={plugin:{id:"CommonTestManagerPlugin",version:"1.0"},"schema-updates":[{id:"test-component",description:"Test Component added",changes:[{location:{parent:"#/$defs/field",id:"type"},update:{enum:[{Test:{enum:[]}}]},replace:!1}]}],"preview-handlers":[]},this.PREVIEW_HANDLER_CONFIG={location:{parent:c.DontCodeModel.APP_FIELDS,id:"type",values:[{Test:{enum:[]}}]},class:{source:"common-test-module",name:"name"}},this.testComponents=n}getConfiguration(){if(null!=this.testComponents){const n=structuredClone(this.CONFIG),e=structuredClone(this.PREVIEW_HANDLER_CONFIG);if(null!=n["schema-updates"]&&null!=n["preview-handlers"])return n["schema-updates"][0].id=this.testComponents.name,n["schema-updates"][0].changes[0].update.enum[0].Test.enum.push(this.testComponents.forType),e.class.name=this.testComponents.name,e.location.values[0].Test.enum.push(this.testComponents.forType),n["preview-handlers"].push(e),n}throw new Error("No testComponent to register")}pluginInit(n){}}class A{exposedPreviewHandlers(){return A.previewHandlers}}A.previewHandlers=new Map,A.\u0275fac=function(n){return new(n||A)},A.\u0275mod=(s.\u0275\u0275registerNgModuleType(A,"dontcode-plugin/common-test-module"),s.\u0275\u0275defineNgModule({type:A,id:"dontcode-plugin/common-test-module"})),A.\u0275inj=s.\u0275\u0275defineInjector({imports:[B.CommonModule,ne]})},5582:(T,P,a)=>{function s(w,b,f,m,h,g,y){try{var v=w[g](y),u=v.value}catch(C){return void f(C)}v.done?b(u):Promise.resolve(u).then(m,h)}function c(w){return function(){var b=this,f=arguments;return new Promise(function(m,h){var g=w.apply(b,f);function y(u){s(g,m,h,y,v,"next",u)}function v(u){s(g,m,h,y,v,"throw",u)}y(void 0)})}}a.d(P,{Z:()=>c})}}]);